<!-- Standard resolution 1024x768 --> 


<!doctype html>
<html>
  <head>
    <style>
  * {
    margin: 0px;
    padding: 0px;
}
  </style>
  
    <title>This is the title of the webpage!</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>



    <script>

        
        
        var lastPlayer = -1;
        let frameid = 0; // deleteMe
        var awaitConfirmation = false;
        function confirmRenderdFrame(frameID, playerId) {
                        awaitConfirmation = true;
                        if(playerId >= 0) {
                                requestData = { 
                                    "player": ""+(playerId),
                                    "last_frame_renderd_ID": ""+frameID
                                };  
                        } else {
                                requestData = {
                                    "last_frame_renderd_ID": ""+frameID
                                };
                        }
                        $.ajax({
                                url: "api/confirm.json",
                                type: "POST",//type of posting the data
                                data: requestData,
                                success: function (data) {
                                        awaitConfirmation = false;
                        },
                                error: function(xhr, ajaxOptions, thrownError){
                                        awaitConfirmation = false;
                        },
                                timeout : 0//timeout of the ajax call
                        });
        }


        var interval = 100;  // Get new Frame from server every [invterval]  milliseconds
        function doAjax() {
             //if(awaitConfirmation) { return; }
             awaitConfirmation = true;

             var currentPlayer = parseInt($("body").find("#changePlayer :selected").val());
             if(lastPlayer != currentPlayer) {
                console.log("Switching from Player "+lastPlayer+" to Player "+currentPlayer);
                lastPlayer = currentPlayer;
                $("#scene").empty();
             }

             
             var requestedUrl = "api/fetchFrame.json";
             var requestData = {};
             if(currentPlayer >= 0) {
                  requestedUrl = "api/player.json";
                  requestData = { "player": ""+(currentPlayer)};
             }
             $.ajax({
                    type: 'GET',
                    url: requestedUrl,
                    AGraphics: $(this).serialize(),
                    contentT: 'json',
                    data: requestData,
                    success: function (AGraphicArray) {                   
                            var updatedIds = {};

                            for(var i = 0; i < AGraphicArray.length; i++){ // < or <=
                                 //console.log(AGraphicArray[i]); // Object
                                 render(AGraphicArray[i]);
                                 updatedIds[""+AGraphicArray[i].owner.id] = true;
                            }

                            $("#scene").find(".graphic").each(function(index, element){
                                var gameObjectId = $(element).attr("id");
                                if(updatedIds[gameObjectId] === undefined) {
                                     $(element).remove();
                                }
                            });

                            confirmRenderdFrame(++frameid, currentPlayer); //   //[To do?] Send server message that it was renderd using real frameID                          
                    },
                    error: function(){
                        awaitConfirmation = false;
                    },
                    complete: function (AGraphics) {
                            // Schedule the next
                            setTimeout(doAjax, interval);
                    }

                  
            });
        }
        setTimeout(doAjax, interval);
        </script>



  </head>
  <body class="overflow:auto;">
        <div id="scene" style="width: 1024px; height: 768px; position: relative; float:left;"></div> <!-- get width and height through json?-->
        <div style="width:200px;height:200px">
                <p>Select Player:</p>
                <select id="changePlayer">
                        <option value="0">Watcher</option> 
                        <option value="1">PlayerOne</option> 
                        <option value="2">PlayerTwo</option> 
                        <option value="3">PlayerThree</option> 
                        <option value="4">PlayerFour</option> 
                </select>
        </div>      
  </body>

  <script>
        var scaleY = window.innerHeight / 768;
        var scaleX = document.body.clientWidth / 1024 ;
        $('#scene').height(768 * scaleY);
        $('#scene').width(1024 * scaleX);
        
      function ObjectAlreadyExists(ObjectId) {
      var elementExists = !!document.getElementById(ObjectId);
      return elementExists;
      }

        function setPosition(HTMLelement,AGraphic) {
        HTMLelement.style.position = 'absolute';
        HTMLelement.style.left = AGraphic.owner.transform.globalPosition.x * scaleX +'px' ;
        HTMLelement.style.top = AGraphic.owner.transform.globalPosition.y * scaleY +'px';
        HTMLelement.style.transform = "rotateZ("+ AGraphic.owner.transform.zRotation+"deg)";
        HTMLelement.style.zIndex = AGraphic.renderingLayer
        HTMLelement.width = AGraphic.width * AGraphic.owner.transform.scale.x * scaleX;
        HTMLelement.height = AGraphic.height * AGraphic.owner.transform.scale.y * scaleY;
        }

      function renderPictureGraphic(pictureGraphic) {
          if (!ObjectAlreadyExists(pictureGraphic.owner.id)) {
            var htmlImageElement = new Image(0, 0);
            document.getElementById("scene").appendChild(htmlImageElement);
            $(htmlImageElement).addClass("graphic");
          } else {
            var htmlImageElement = document.getElementById(pictureGraphic.owner.id);
          }

          var prevSrc = htmlImageElement.getAttribute("data-src");
          if(prevSrc == undefined || prevSrc.localeCompare(pictureGraphic.picturePath) != 0) {
              htmlImageElement.src = pictureGraphic.picturePath;
              htmlImageElement.setAttribute("data-src", pictureGraphic.picturePath);
          }

          htmlImageElement.id = pictureGraphic.owner.id;
          setPosition(htmlImageElement,pictureGraphic);
      }

      //Wie funktioniert skalierung bei Text? Was ist x-skalierung / y-skalierung bei text?
      function renderLabelGraphic(labelGraphic) {
      if (!ObjectAlreadyExists(labelGraphic.owner.id)) {
      var p = document.createElement('p');
      document.getElementById('scene').appendChild(p);
      $(p).addClass("graphic");
      } else {
      var p = document.getElementById(labelGraphic.owner.id);
      }

      p.innerHTML = labelGraphic.labelText;
      if (labelGraphic.bold == "true") {
        p.style.fontWeight = "bolder";
      } else {
        p.style.fontWeight = "normal";
      }
      p.style.fontFamily = labelGraphic.fontFamily;
      p.id = labelGraphic.owner.id;
      p.style.color = labelGraphic.color;
      p.style.fontSize = labelGraphic.fontSize * ((scaleY + scaleX) / 2) +'px';
      setPosition(p,labelGraphic);
      }

      function renderInputGraphic(inputGraphic) {
          if (!ObjectAlreadyExists(inputGraphic.owner.id)) {
              var input = document.createElement('input');
              input.setAttribute('type', 'text');
              document.getElementById('scene').appendChild(input);
              $(input).addClass("graphic");
              input.addEventListener("input",function () {
                  var target = event.target;
                  var elementId = target.getAttribute('id');
                  var value = $(target).val();
                  obj = {
                      '@type': 'DAF.Event.TextInputEvent',
                      'source': ""+elementId,
                      'controller': ""+lastPlayer,
                      'text': ""+value
                  }

                  $.ajax({
                      type: "POST",
                      url: "api/event.json",
                      contentType: "application/json; charset=UTF-8",
                      dataType: "json",
                      data: { data: JSON.stringify(obj) },
                      success: function (data) {
                      console.log("Success")
                      console.log("Data: "+data);
                      },
                      error: function (jqXHR, textStatus, errorThrown) {
                      console.log(jqXHR);
                      console.log(textStatus);
                      console.log(errorThrown);
                      console.log('Error Event');
                      }
                  });
              }, false);
          } else {
              var input = document.getElementById(inputGraphic.owner.id);
          }

          input.innerHTML = inputGraphic.text;
          var bold;
          if (inputGraphic.bold) {
            bold = "bold";
          } else {
            bold = "";
          }
          input.id = inputGraphic.owner.id;
          input.value = inputGraphic.text;
          input.style.width = inputGraphic.width+"px";
          input.style.height = inputGraphic.height+"px";
          input.style.fontWeight = bold;
          input.style.fontSize = inputGraphic.fontsize+'px';
          setPosition(input,inputGraphic);
      }

      // [To do] picturepath, scale.
      function renderButtonGraphic(buttonGraphic) {
      if (!ObjectAlreadyExists(buttonGraphic.owner.id)) {
          var button = document.createElement('button');
          document.getElementById('scene').appendChild(button);
          $(button).addClass("graphic");

          button.addEventListener('click', function(event) {
              var target = event.target;
              var elementId = target.getAttribute('id');
              obj = {
                  '@type': 'DAF.Event.ButtonInputEvent',
                  'keycode': "0",
                  'source': ""+elementId,
                  'controller': ""+lastPlayer
              }

              $.ajax({
                  type: "POST",
                  url: "api/event.json",
                  contentType: "application/json; charset=UTF-8",
                  dataType: "json",
                  data: { data: JSON.stringify(obj) },
                  success: function (data) {
                      console.log("Success")
                      console.log("Data: "+data);
                  },
                  error: function (jqXHR, textStatus, errorThrown) {
                      console.log(jqXHR);
                      console.log(textStatus);
                      console.log(errorThrown);
                      console.log('Error Event');
                  }
              });
          }, false);
      } else {
        var button = document.getElementById(buttonGraphic.owner.id);
      }

      var bold;
      if (buttonGraphic.bold) {
        bold = "bold";
      } else {
        bold = "";
      }


          button.style.fontWeight = bold;
          button.innerHTML = buttonGraphic.labelText;
          button.style.fontSize = buttonGraphic.fontSize * ((scaleY + scaleX) / 2) +'px';
          button.type = "button";
          button.id = buttonGraphic.owner.id;
          setPosition(button,buttonGraphic);

      }


  </script>

<script>
        function render(AGraphic) {
                if (AGraphic["@type"].endsWith("PictureGraphic")) { //
                        renderPictureGraphic(AGraphic);
                }
                if (AGraphic["@type"].endsWith("LabelGraphic")) { //
                        renderLabelGraphic(AGraphic);
                }
                if (AGraphic["@type"].endsWith("ButtonGraphic")) { //
                        renderButtonGraphic(AGraphic);
                }
                if (AGraphic["@type"].endsWith("InputGraphic")) { //
                    renderInputGraphic(AGraphic);
                }
        }
</script>

  <script>
      //Überlegung: Anstatt die Mausposition / Click übertragen, übertragen auf welche AGraphic gegklickt wurde (und mit welcher Maustaste)? Anhand Gameobject ID identifizieren.
      scene.addEventListener('click', function(event) {
          var rect = scene.getBoundingClientRect();
          var x = (event.pageX  / scaleX) - rect.left,
              y =  (event.pageY / scaleY) - rect.top;
          console.log("x =" +x +" y ="+y);

          obj = {
              '@type': 'DAF.Event.MouseInputEvent',
              'keycode': "1",
              'x': ""+x,
              'y': ""+y,
              'controller': ""+lastPlayer
          }

          $.ajax({
              type: "POST",
              url: "api/event.json",
              contentType: "application/json; charset=UTF-8",
              dataType: "json",
              data: { data: JSON.stringify(obj) },
              success: function (data) {
                  console.log("Success")
                  console.log("Data: "+data);
              },
              error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
                console.log(textStatus);
                console.log(errorThrown);
                console.log('Error Event');
              }
          });




      }, false);


  </script>

</html>
